<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tecla - Plataforma de Conex√£o Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');

        :root { 
            --primary: #3b82f6; 
            --slate-950: #020617;
        }

        body {
            background-color: var(--slate-950);
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            position: fixed;
            width: 100%; height: 100%;
        }

        .glass { 
            background: rgba(15, 23, 42, 0.85); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
        }

        /* Otimiza√ß√£o de Anima√ß√£o */
        #sideMenu {
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            transform: translateX(100%);
            will-change: transform;
        }
        #sideMenu.open { transform: translateX(0); }

        .message-anim { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }

        .listening {
            animation: pulse-red 1.5s infinite;
            background: #ef4444 !important;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        /* Scrollbar oculta mas funcional */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body class="fixed inset-0 flex flex-col">

    <!-- Gate de Entrada -->
    <div id="voiceGate" class="fixed inset-0 z-[200] flex items-center justify-center bg-slate-950 p-6 transition-opacity duration-500">
        <div class="p-10 glass rounded-[3rem] max-w-sm text-center shadow-2xl relative overflow-hidden">
            <div class="absolute inset-0 bg-blue-600/10 blur-3xl rounded-full scale-150 animate-pulse"></div>
            <div class="relative z-10">
                <h1 class="text-6xl font-extrabold mb-2 bg-gradient-to-b from-white to-blue-500 bg-clip-text text-transparent italic tracking-tighter">TECLA</h1>
                <p id="gateSubtitle" class="mb-8 text-slate-400 text-[10px] font-black uppercase tracking-[0.3em]">Conex√£o Humana & IA</p>
                
                <div class="space-y-3 mb-8">
                    <button onclick="showLogin('usuario')" id="btnUserLogin" class="w-full py-4 bg-blue-600 rounded-2xl font-black text-xs tracking-widest hover:bg-blue-500 transition-all shadow-lg shadow-blue-900/50">ENTRAR COMO USU√ÅRIO</button>
                    <button onclick="showLogin('cuidador')" id="btnCareLogin" class="w-full py-4 glass rounded-2xl font-black text-xs tracking-widest hover:bg-white/5 transition-all">ENTRAR COMO CUIDADOR</button>
                </div>
                <p id="gateQuote" class="text-[9px] text-slate-600 italic">"Nenhuma voz deve ser silenciada."</p>
            </div>
        </div>
    </div>

    <!-- Modal de Login -->
    <div id="loginModal" class="fixed inset-0 z-[210] glass flex items-center justify-center hidden p-6 backdrop-blur-xl">
        <div class="p-8 bg-slate-900/95 rounded-[2.5rem] w-full max-w-xs border border-white/10 shadow-2xl">
            <h2 id="loginTitle" class="text-xl font-black mb-6 uppercase tracking-tighter text-white italic">Login</h2>
            <input type="email" id="loginEmail" placeholder="Email" class="w-full p-4 bg-slate-950 rounded-xl mb-3 text-sm outline-none border border-white/5 text-white focus:border-blue-500 transition-colors">
            <input type="password" id="loginPass" placeholder="Palavra-passe" class="w-full p-4 bg-slate-950 rounded-xl mb-6 text-sm outline-none border border-white/5 text-white focus:border-blue-500 transition-colors">
            <button onclick="enableVoiceAndStartApp()" id="btnLoginAction" class="w-full py-4 bg-blue-600 rounded-xl font-black text-xs uppercase hover:bg-blue-500 transition-colors">Acessar Portal</button>
            <button onclick="hideLogin()" id="btnCancelLogin" class="w-full py-3 mt-2 text-slate-500 text-[10px] font-bold uppercase tracking-widest hover:text-white transition-colors">Cancelar</button>
        </div>
    </div>

    <!-- Menu Lateral -->
    <div id="menuOverlay" onclick="toggleMenu()" class="fixed inset-0 bg-black/80 z-[100] hidden backdrop-blur-sm transition-all"></div>
    <aside id="sideMenu" class="fixed top-0 right-0 h-full glass z-[110] w-[85%] max-w-[320px] p-8 flex flex-col overflow-y-auto border-l border-white/10 shadow-2xl">
        <div class="flex justify-between items-center mb-10">
            <span id="menuLabel" class="text-[10px] font-black tracking-widest text-blue-500 uppercase">Governan√ßa e Configura√ß√µes</span>
            <button onclick="toggleMenu()" class="p-2 text-white hover:text-blue-400 transition-colors">‚úï</button>
        </div>

        <!-- Mensagem de Governan√ßa -->
        <div class="mb-8 p-6 rounded-[2rem] bg-blue-600/5 border border-blue-500/20">
            <h3 id="govTitle" class="text-xs font-black mb-3 uppercase text-blue-400">Sobre a Plataforma</h3>
            <p id="govMessage" class="text-[10px] text-slate-300 leading-relaxed italic">
                <!-- Conte√∫do injetado via JS -->
            </p>
        </div>

        <!-- Sele√ß√£o de Idioma -->
        <div class="mb-8">
            <h3 id="langLabel" class="text-[10px] font-black mb-4 uppercase text-slate-500 tracking-widest">Idioma do Sistema</h3>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="setLanguage('pt-PT')" class="p-3 glass rounded-xl text-[9px] font-bold hover:bg-blue-600/20 transition-all text-white border border-transparent hover:border-blue-500/30">Portugu√™s</button>
                <button onclick="setLanguage('en-US')" class="p-3 glass rounded-xl text-[9px] font-bold hover:bg-blue-600/20 transition-all text-white border border-transparent hover:border-blue-500/30">English</button>
                <button onclick="setLanguage('fr-FR')" class="p-3 glass rounded-xl text-[9px] font-bold hover:bg-blue-600/20 transition-all text-white border border-transparent hover:border-blue-500/30">Fran√ßais</button>
                <button onclick="setLanguage('zh-CN')" class="p-3 glass rounded-xl text-[9px] font-bold hover:bg-blue-600/20 transition-all text-white border border-transparent hover:border-blue-500/30">‰∏≠Êñá</button>
            </div>
        </div>

        <!-- Doa√ß√£o -->
        <div class="mb-8 p-6 rounded-[2rem] bg-gradient-to-br from-pink-600/10 to-transparent border border-pink-500/20">
            <h3 id="donateLabel" class="text-xs font-black mb-2 uppercase text-white">Apoie a Tecla üíù</h3>
            <p id="donateText" class="text-[10px] text-slate-400 leading-relaxed mb-4">Sua doa√ß√£o ajuda a expandir nossa IA e manter a plataforma gratuita.</p>
            <div class="space-y-2">
                <form action="https://www.paypal.com/donate" method="post" target="_blank">
                    <input type="hidden" name="business" value="dalla.decarvalho@gmail.com" />
                    <button type="submit" class="block w-full py-3 bg-white/5 hover:bg-pink-600/20 text-center rounded-xl text-[9px] font-black uppercase tracking-widest border border-white/5 text-white transition-all">PAYPAL</button>
                </form>
            </div>
        </div>

        <button onclick="toggleModo(); toggleMenu();" class="w-full p-5 glass rounded-2xl flex justify-between items-center mb-4 hover:bg-white/5 transition-all">
            <span id="dashLabel" class="text-[10px] font-black uppercase text-white">Dashboard Cuidador</span>
            <span id="badgeModo" class="text-[8px] bg-blue-500 px-2 py-1 rounded text-white shadow-lg shadow-blue-500/30">USER</span>
        </button>

        <div class="mt-auto text-center opacity-30 text-[8px] font-black uppercase tracking-[0.5em] text-white">TECLA ECOSYSTEM</div>
    </aside>

    <!-- Header -->
    <header class="p-5 flex justify-between items-center glass z-40 shrink-0 border-b border-white/5">
        <div class="flex items-center space-x-3">
            <span class="font-black italic text-xl tracking-tighter text-white">TECLA</span>
            <div id="aiIndicator" class="flex items-center space-x-1 px-3 py-1 bg-green-500/10 rounded-full border border-green-500/20">
                <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse shadow-[0_0_10px_#22c55e]"></div>
                <span id="aiStatusText" class="text-[7px] font-black text-green-500 uppercase italic tracking-wider">IA Ativa</span>
            </div>
        </div>
        <button onclick="toggleMenu()" class="p-3 glass rounded-xl text-white hover:bg-white/10 transition-all">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
    </header>

    <main class="flex-1 flex flex-col relative overflow-hidden bg-slate-950">
        
        <!-- Dashboard Admin -->
        <section id="dashboardSection" class="hidden absolute inset-0 z-50 glass p-6 overflow-y-auto backdrop-blur-3xl">
            <h3 id="dashTitle" class="text-xs font-black mb-6 uppercase tracking-widest text-blue-500 italic">Monitoramento de Atividade</h3>
            
            <div class="bg-slate-900/50 p-4 rounded-[2rem] border border-white/5 mb-6 shadow-inner">
                <canvas id="interactionChart" height="200"></canvas>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-4 glass rounded-2xl text-center">
                    <span id="statLabelTotal" class="text-[8px] font-black text-slate-500 uppercase block mb-1 tracking-widest">Total Hoje</span>
                    <span id="statTotal" class="text-2xl font-black text-white">0</span>
                </div>
                <div class="p-4 glass rounded-2xl text-center">
                    <span id="statLabelMood" class="text-[8px] font-black text-slate-500 uppercase block mb-1 tracking-widest">Humor M√©dio</span>
                    <span id="statMood" class="text-2xl font-black text-blue-400">Est√°vel</span>
                </div>
            </div>

            <div class="p-6 glass rounded-[2rem] border-white/5">
                <h4 id="aiConfigLabel" class="text-[9px] font-black uppercase text-slate-500 mb-3 tracking-widest">Configura√ß√µes de IA</h4>
                <div id="aiInfoText" class="bg-blue-900/20 p-3 rounded-lg mb-4 text-[9px] text-blue-200">
                    * A IA Local est√° ativa por padr√£o. Use a API apenas para modelos externos avan√ßados.
                </div>
                <input type="password" id="api_key_input" placeholder="Chave Gemini API (Opcional)" class="w-full p-4 bg-slate-950 rounded-xl mb-3 text-xs outline-none border border-white/5 text-white focus:border-blue-500 transition-colors">
                <button onclick="salvarEstado()" id="btnSync" class="w-full py-4 bg-blue-600 rounded-xl font-black text-[10px] uppercase italic hover:bg-blue-500 transition-colors">Sincronizar Canal</button>
            </div>
        </section>

        <!-- Chat Principal -->
        <div id="chatDisplay" class="flex-1 overflow-y-auto p-5 space-y-4 scroll-smooth"></div>

        <!-- Pictogramas R√°pidos -->
        <div id="pictogramasGrid" class="grid grid-cols-3 gap-3 px-5 pb-3 shrink-0"></div>

        <!-- Input -->
        <div class="pb-safe px-5 pb-5 shrink-0">
            <div class="flex items-center glass rounded-[2.5rem] p-2 shadow-2xl space-x-2 border border-white/10">
                <button id="micBtn" onclick="toggleListening()" class="p-4 glass rounded-full hover:bg-white/10 transition-all text-blue-500 relative overflow-hidden">
                    <svg class="w-6 h-6 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                </button>
                <input type="text" id="entrada" onkeypress="if(event.key==='Enter') responder()" placeholder="Escreva..." class="flex-1 bg-transparent px-2 py-4 outline-none text-base font-medium text-white placeholder-slate-500">
                <button onclick="responder()" class="p-4 bg-blue-600 rounded-full active:scale-90 transition-transform shadow-lg shadow-blue-600/30 hover:bg-blue-500">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M13 5l7 7-7 7M5 5l7 7-7 7"/></svg>
                </button>
            </div>
        </div>
    </main>

    <script>
        // --- SMART ENGINE (IA LOCAL OTIMIZADA & UNIVERSAL) ---
        const SmartEngine = {
            process: (input, lang) => {
                const text = input.toLowerCase().trim();
                
                // Padr√µes de Resposta Inteligente
                const patterns = {
                    'pt-PT': [
                        { keys: ['fome', 'comer', 'almo√ßo', 'jantar', 'comida'], response: "Entendi que voc√™ precisa se alimentar. Vamos providenciar algo gostoso para comer agora." },
                        { keys: ['sede', 'beber', '√°gua', 'suco', 'ch√°'], response: "Percebo que voc√™ est√° com sede. Vou buscar uma bebida fresca para hidratar voc√™." },
                        { keys: ['dor', 'd√≥i', 'machucado', 'desconforto'], response: "Sinto muito que esteja com dor. Por favor, mostre onde d√≥i para que eu possa ajudar a aliviar." },
                        { keys: ['banho', 'lavar', 'limpar', 'sujo'], response: "Compreendo, voc√™ quer tomar um banho para se sentir renovado. Vamos preparar tudo com cuidado." },
                        { keys: ['sono', 'dormir', 'cansado', 'cama'], response: "Parece que o dia foi longo. Est√° na hora de descansar. Vou ajudar voc√™ a se deitar confortavelmente." },
                        { keys: ['banheiro', 'sanita', 'xixi', 'coc√¥'], response: "Entendido, voc√™ precisa ir ao banheiro. Vamos l√° com calma, estou aqui para apoiar." },
                        { keys: ['frio', 'gelado', 'cobertor'], response: "Se voc√™ est√° com frio, vou buscar um cobertor ou agasalho para aquecer voc√™ imediatamente." },
                        { keys: ['calor', 'quente', 'suando'], response: "Est√° calor, n√£o √©? Vamos abrir uma janela ou ligar a ventila√ß√£o para voc√™ se sentir melhor." },
                        { keys: ['amor', 'gosto', 'amo', 'carinho'], response: "Que mensagem linda. O carinho √© rec√≠proco e √© muito bom ter essa conex√£o com voc√™." },
                        { keys: ['triste', 'chora', 'choro'], response: "Estou vendo que voc√™ est√° triste. Estou aqui ao seu lado. Se quiser, ficamos em sil√™ncio juntos." },
                        { keys: ['feliz', 'bom', 'alegria'], response: "Que maravilha saber que voc√™ est√° feliz! Sua alegria ilumina o nosso ambiente." },
                        { keys: ['ajuda', 'socorro', 'preciso'], response: "Estou atento. Diga-me exatamente o que precisa, estou inteiramente √† sua disposi√ß√£o." },
                        { keys: ['sim', 'quero', 'pode'], response: "Certo, entendi sua confirma√ß√£o. Vamos prosseguir com isso." },
                        { keys: ['n√£o', 'pare', 'nunca'], response: "Compreendido. Vamos parar ou mudar o que estamos fazendo para respeitar sua vontade." }
                    ],
                    'en-US': [
                        { keys: ['hungry', 'eat', 'food', 'lunch', 'dinner'], response: "I understand you need to eat. Let's get something delicious for you right now." },
                        { keys: ['thirsty', 'drink', 'water', 'juice'], response: "I see you are thirsty. I will get a fresh drink to hydrate you." },
                        { keys: ['pain', 'hurt', 'ache'], response: "I am sorry you are in pain. Please show me where it hurts so I can help." },
                        { keys: ['bath', 'shower', 'clean', 'wash'], response: "I understand, you want to take a bath to feel refreshed. Let's prepare everything carefully." },
                        { keys: ['sleep', 'tired', 'bed'], response: "It seems it's been a long day. It is time to rest. I will help you lie down comfortably." },
                        { keys: ['help', 'aid'], response: "I am attentive. Tell me exactly what you need, I am entirely at your disposal." },
                        { keys: ['love', 'like'], response: "What a beautiful message. The affection is mutual and it is great to have this connection with you." }
                    ],
                    'fr-FR': [
                        { keys: ['faim', 'manger', 'repas'], response: "Je comprends que vous avez besoin de manger. Pr√©parons quelque chose de d√©licieux maintenant." },
                        { keys: ['soif', 'boire', 'eau'], response: "Je vois que vous avez soif. Je vais chercher une boisson fra√Æche pour vous hydrater." },
                        { keys: ['douleur', 'mal'], response: "Je suis d√©sol√© que vous souffriez. Montrez-moi o√π √ßa fait mal pour que je puisse aider." },
                        { keys: ['bain', 'laver', 'douche'], response: "Je comprends, vous voulez prendre un bain. Pr√©parons tout avec soin." },
                        { keys: ['dormir', 'fatigu√©', 'lit'], response: "La journ√©e a √©t√© longue. Il est temps de se reposer. Je vais vous aider √† vous installer confortablement." },
                        { keys: ['aide', 'secours'], response: "Je suis attentif. Dites-moi exactement ce dont vous avez besoin, je suis enti√®rement √† votre disposition." },
                        { keys: ['amour', 'aime'], response: "Quel beau message. L'affection est r√©ciproque et c'est bon d'avoir cette connexion avec vous." }
                    ],
                    'zh-CN': [
                        { keys: ['È•ø', 'ÂêÉ', 'È•≠'], response: "ÊàëÊòéÁôΩ‰Ω†ÈúÄË¶ÅÂêÉ‰∏úË•ø„ÄÇËÆ©Êàë‰ª¨Áé∞Âú®Â∞±ÂéªÂáÜÂ§á‰∏Ä‰∫õÁæéÂë≥ÁöÑÈ£üÁâ©„ÄÇ" },
                        { keys: ['Ê∏¥', 'Âñù', 'Ê∞¥'], response: "ÊàëÁúã‰Ω†Ê∏¥‰∫Ü„ÄÇÊàëÂéªÊãø‰∏ÄÊùØÊñ∞È≤úÁöÑÈ•ÆÊñôÁªô‰Ω†Ë°•ÂÖÖÊ∞¥ÂàÜ„ÄÇ" },
                        { keys: ['Áóõ', 'Áñº'], response: "ÊàëÂæàÈÅóÊÜæ‰Ω†ÊÑüÂà∞ÁñºÁóõ„ÄÇËØ∑ÂëäËØâÊàëÂì™ÈáåÁóõÔºå‰ª•‰æøÊàëËÉΩÊèê‰æõÂ∏ÆÂä©„ÄÇ" },
                        { keys: ['Ê¥óÊæ°', 'Ê¥ó'], response: "ÊàëÊòéÁôΩÔºå‰Ω†ÊÉ≥Ê¥ó‰∏™Êæ°ËÆ©Ëá™Â∑±ÁÑïÁÑ∂‰∏ÄÊñ∞„ÄÇËÆ©Êàë‰ª¨Á≤æÂøÉÂáÜÂ§á‰∏ÄÂàá„ÄÇ" },
                        { keys: ['Áù°', 'Á¥Ø', 'Â∫ä'], response: "ÁúãÊù•ËøôÊòØÊº´ÈïøÁöÑ‰∏ÄÂ§©„ÄÇÊòØÊó∂ÂÄô‰ºëÊÅØ‰∫Ü„ÄÇÊàë‰ºöÂ∏Æ‰Ω†ËàíÊúçÂú∞Ë∫∫‰∏ã„ÄÇ" },
                        { keys: ['Â∏ÆÂä©', 'ÊïëÂëΩ'], response: "ÊàëÂú®Âê¨„ÄÇËØ∑Á°ÆÂàáÂëäËØâÊàë‰Ω†ÈúÄË¶Å‰ªÄ‰πàÔºåÊàëÂÆåÂÖ®Âê¨‰ªé‰Ω†ÁöÑÂê©Âíê„ÄÇ" },
                        { keys: ['Áà±', 'ÂñúÊ¨¢'], response: "Â§ö‰πàÁæéÂ•ΩÁöÑ‰ø°ÊÅØ„ÄÇËøô‰ªΩÊÑüÊÉÖÊòØÁõ∏‰∫íÁöÑÔºåÂæàÈ´òÂÖ¥ËÉΩ‰∏é‰Ω†ÊúâËøôÊ†∑ÁöÑËÅîÁ≥ª„ÄÇ" }
                    ]
                };

                const langPatterns = patterns[lang] || patterns['pt-PT'];
                
                // 1. Busca por correspond√™ncia exata de palavra-chave
                for (let pattern of langPatterns) {
                    if (pattern.keys.some(k => text.includes(k))) {
                        return pattern.response;
                    }
                }

                // 2. Resposta de Acolhimento Universal (Fallback Inteligente)
                // Se n√£o entender o contexto espec√≠fico, acolhe a inten√ß√£o de comunica√ß√£o.
                const fallbacks = {
                    'pt-PT': `Entendi sua mensagem: "${input}". Sinto a emo√ß√£o nas suas palavras e estou aqui para apoiar voc√™ em tudo o que precisar.`,
                    'en-US': `I received your message: "${input}". I feel the emotion in your words and I am here to support you in whatever you need.`,
                    'fr-FR': `J'ai bien re√ßu votre message : "${input}". Je ressens l'√©motion dans vos mots et je suis l√† pour vous soutenir.`,
                    'zh-CN': `ÊàëÊî∂Âà∞‰∫Ü‰Ω†ÁöÑ‰ø°ÊÅØÔºö‚Äú${input}‚Äù„ÄÇÊàëËÉΩÊÑüÂèóÂà∞‰Ω†ËØùËØ≠‰∏≠ÁöÑÊÉÖÊÑüÔºåÊàë‰ºöÂú®ËøôÈáåÊîØÊåÅ‰Ω†ÁöÑ‰∏ÄÂàáÈúÄÊ±Ç„ÄÇ`
                };

                return fallbacks[lang] || fallbacks['pt-PT'];
            }
        };

        // --- Vari√°veis de Estado ---
        let currentLang = 'pt-PT';
        let modo = 'user';
        let apiKey = '';
        let interactionsCount = 0;
        let chartInstance = null;
        let recognition = null;
        let isListening = false;

        const translations = {
            'pt-PT': {
                gateSubtitle: 'Conex√£o Humana & IA',
                btnUser: 'ENTRAR COMO USU√ÅRIO',
                btnCare: 'ENTRAR COMO CUIDADOR',
                gateQuote: '"Nenhuma voz deve ser silenciada."',
                loginTitle: 'Acesso Restrito',
                btnLogin: 'ACESSAR PORTAL',
                btnCancel: 'CANCELAR',
                menuLabel: 'Governan√ßa e Configura√ß√µes',
                govTitle: 'Sobre a Plataforma',
                govMessage: 'A Tecla, criada por Dala de Carvalho, nasce da convic√ß√£o de que comunicar √© um direito fundamental. Este ecossistema devolve a autonomia a quem a perdeu, garantindo que a dignidade humana e a express√£o individual sejam preservadas atrav√©s de tecnologia, prote√ß√£o e amor.',
                langLabel: 'Idioma do Sistema',
                donateLabel: 'Apoie a Tecla üíù',
                donateText: 'Sua doa√ß√£o ajuda a expandir nossa IA e manter a plataforma gratuita.',
                dashLabel: 'Dashboard Cuidador',
                aiStatus: 'IA Ativa',
                dashTitle: 'Monitoramento de Atividade',
                statTotalLabel: 'Total Hoje',
                statMoodLabel: 'Humor M√©dio',
                statMoodValue: 'Est√°vel',
                aiConfig: 'Configura√ß√µes de IA',
                aiInfo: '* A IA Local est√° ativa por padr√£o. Use a API apenas para modelos externos avan√ßados.',
                apiKeyPlaceholder: 'Chave Gemini API (Opcional)',
                btnSync: 'Sincronizar Canal',
                welcome: 'Conex√£o estabelecida. Sinto sua presen√ßa. Como posso ajudar hoje?',
                placeholder: 'Escreva ou use o microfone...',
                emailHolder: 'Email',
                passHolder: 'Palavra-passe',
                icons: { comer: 'Fome', dor: 'Dor', ajuda: 'Ajuda', banho: 'Banho', amor: 'Amor', dormir: 'Sono' }
            },
            'en-US': {
                gateSubtitle: 'Human & AI Connection',
                btnUser: 'ENTER AS USER',
                btnCare: 'ENTER AS CAREGIVER',
                gateQuote: '"No voice should be silenced."',
                loginTitle: 'Restricted Access',
                btnLogin: 'ACCESS PORTAL',
                btnCancel: 'CANCEL',
                menuLabel: 'Governance & Settings',
                govTitle: 'About the Platform',
                govMessage: 'Tecla, created by Dala de Carvalho, is born from the conviction that communication is a fundamental right. This ecosystem restores autonomy to those who have lost it, ensuring human dignity and individual expression are preserved through technology, protection, and love.',
                langLabel: 'System Language',
                donateLabel: 'Support Tecla üíù',
                donateText: 'Your donation helps expand our AI and keep the platform free.',
                dashLabel: 'Caregiver Dashboard',
                aiStatus: 'AI Active',
                dashTitle: 'Activity Monitoring',
                statTotalLabel: 'Total Today',
                statMoodLabel: 'Average Mood',
                statMoodValue: 'Stable',
                aiConfig: 'AI Settings',
                aiInfo: '* Local AI is active by default. Use API only for advanced external models.',
                apiKeyPlaceholder: 'Gemini API Key (Optional)',
                btnSync: 'Sync Channel',
                welcome: 'Connection established. I feel your presence. How can I help today?',
                placeholder: 'Type or use microphone...',
                emailHolder: 'Email',
                passHolder: 'Password',
                icons: { comer: 'Hungry', dor: 'Pain', ajuda: 'Help', banho: 'Bath', amor: 'Love', dormir: 'Sleep' }
            },
            'fr-FR': {
                gateSubtitle: 'Connexion Humaine & IA',
                btnUser: 'ENTRER COMME UTILISATEUR',
                btnCare: 'ENTRER COMME AIDANT',
                gateQuote: '"Aucune voix ne doit √™tre r√©duite au silence."',
                loginTitle: 'Acc√®s Restreint',
                btnLogin: 'ACC√âDER AU PORTAIL',
                btnCancel: 'ANNULER',
                menuLabel: 'Gouvernance et Param√®tres',
                govTitle: '√Ä propos de la plateforme',
                govMessage: 'Tecla, cr√©√©e par Dala de Carvalho, na√Æt de la conviction que communiquer est un droit fondamental. Cet √©cosyst√®me redonne l\'autonomie √† ceux qui l\'ont perdue, garantissant que la dignit√© humaine et l\'expression individuelle soient pr√©serv√©es gr√¢ce √† la technologie, √† la protection et √† l\'amour.',
                langLabel: 'Langue du Syst√®me',
                donateLabel: 'Soutenir Tecla üíù',
                donateText: 'Votre don aide √† d√©velopper notre IA et √† maintenir la plateforme gratuite.',
                dashLabel: 'Tableau de bord',
                aiStatus: 'IA Active',
                dashTitle: 'Suivi d\'activit√©',
                statTotalLabel: 'Total Aujourd\'hui',
                statMoodLabel: 'Humeur Moyenne',
                statMoodValue: 'Stable',
                aiConfig: 'Param√®tres d\'IA',
                aiInfo: '* L\'IA locale est active par d√©faut. Utilisez l\'API uniquement pour les mod√®les avanc√©s.',
                apiKeyPlaceholder: 'Cl√© API Gemini (Optionnel)',
                btnSync: 'Synchroniser le canal',
                welcome: 'Connexion √©tablie. Je sens votre pr√©sence. Comment aider?',
                placeholder: '√âcrivez ou utilisez le micro...',
                emailHolder: 'E-mail',
                passHolder: 'Mot de passe',
                icons: { comer: 'Faim', dor: 'Douleur', ajuda: 'Aide', banho: 'Bain', amor: 'Amour', dormir: 'Dormir' }
            },
            'zh-CN': {
                gateSubtitle: '‰∫∫Á±ª‰∏é‰∫∫Â∑•Êô∫ËÉΩËøûÊé•',
                btnUser: '‰ª•Áî®Êà∑Ë∫´‰ªΩËøõÂÖ•',
                btnCare: '‰ª•Êä§ÁêÜ‰∫∫ÂëòË∫´‰ªΩËøõÂÖ•',
                gateQuote: '‚Äú‰ªª‰ΩïÂ£∞Èü≥ÈÉΩ‰∏çÂ∫îËØ•Ë¢´Ê≤âÈªò„ÄÇ‚Äù',
                loginTitle: 'ÂèóÈôêËÆøÈóÆ',
                btnLogin: 'ËøõÂÖ•Èó®Êà∑',
                btnCancel: 'ÂèñÊ∂à',
                menuLabel: 'Ê≤ªÁêÜ‰∏éËÆæÁΩÆ',
                govTitle: 'ÂÖ≥‰∫éÂπ≥Âè∞',
                govMessage: 'Tecla Áî± Dala de Carvalho ÂàõÁ´ãÔºåÊ∫ê‰∫éÊ≤üÈÄöÊòØ‰∏ÄÈ°πÂü∫Êú¨ÊùÉÂà©ÁöÑ‰ø°Âøµ„ÄÇËØ•ÁîüÊÄÅÁ≥ªÁªüÈÄöËøáÊäÄÊúØ„ÄÅ‰øùÊä§ÂíåÁà±Ôºå‰∏∫Â§±ÂéªÊ≤üÈÄöËÉΩÂäõÁöÑ‰∫∫ÊÅ¢Â§çËá™‰∏ªÊùÉÔºåÁ°Æ‰øù‰∫∫Á±ªÂ∞ä‰∏•Âíå‰∏™‰∫∫Ë°®ËææÂæóÂà∞Áª¥Êä§„ÄÇ',
                langLabel: 'Á≥ªÁªüËØ≠Ë®Ä',
                donateLabel: 'ÊîØÊåÅ Tecla üíù',
                donateText: 'ÊÇ®ÁöÑÊçêÊ¨æÊúâÂä©‰∫éÊâ©Â±ïÊàë‰ª¨ÁöÑ‰∫∫Â∑•Êô∫ËÉΩ„ÄÇ',
                dashLabel: 'Êä§ÁêÜ‰∫∫Âëò‰ª™Ë°®Êùø',
                aiStatus: '‰∫∫Â∑•Êô∫ËÉΩÊ¥ªË∑É',
                dashTitle: 'Ê¥ªÂä®ÁõëÊµã',
                statTotalLabel: '‰ªäÊó•ÊÄªËÆ°',
                statMoodLabel: 'Âπ≥ÂùáÊÉÖÁª™',
                statMoodValue: 'Á®≥ÂÆö',
                aiConfig: '‰∫∫Â∑•Êô∫ËÉΩËÆæÁΩÆ',
                aiInfo: '* Êú¨Âú∞‰∫∫Â∑•Êô∫ËÉΩÈªòËÆ§Â§Ñ‰∫éÊ¥ªÂä®Áä∂ÊÄÅ„ÄÇ‰ªÖÂ∞Ü API Áî®‰∫éÈ´òÁ∫ßÂ§ñÈÉ®Ê®°Âûã„ÄÇ',
                apiKeyPlaceholder: 'Gemini API ÂØÜÈí• (ÂèØÈÄâ)',
                btnSync: 'ÂêåÊ≠•È¢ëÈÅì',
                welcome: 'ËøûÊé•Â∑≤Âª∫Á´ã„ÄÇÊàëÊÑüËßâÂà∞‰Ω†ÁöÑÂ≠òÂú®„ÄÇÊÄé‰πàÂ∏Æ‰Ω†Ôºü',
                placeholder: 'ËæìÂÖ•Êàñ‰ΩøÁî®È∫¶ÂÖãÈ£é...',
                emailHolder: 'ÁîµÂ≠êÈÇÆ‰ª∂',
                passHolder: 'ÂØÜÁ†Å',
                icons: { comer: 'È•ø', dor: 'Áóõ', ajuda: 'Â∏ÆÂä©', banho: 'Ê¥óÊæ°', amor: 'Áà±', dormir: 'Áù°Ëßâ' }
            }
        };

        const iconsData = [
            { key: 'comer', i: 'üçΩÔ∏è' }, { key: 'dor', i: 'ü§ï' }, { key: 'ajuda', i: 'üÜò' },
            { key: 'banho', i: 'üöø' }, { key: 'amor', i: '‚ù§Ô∏è' }, { key: 'dormir', i: 'üò¥' }
        ];

        // --- Fun√ß√µes de UI e L√≥gica ---

        function setLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];
            
            // Atualiza textos est√°ticos
            const ids = ['gateSubtitle', 'btnUserLogin', 'btnCareLogin', 'gateQuote', 'loginTitle', 'btnLoginAction', 'btnCancelLogin', 'menuLabel', 'govTitle', 'govMessage', 'langLabel', 'donateLabel', 'donateText', 'dashLabel', 'aiStatusText', 'dashTitle', 'statLabelTotal', 'statLabelMood', 'statMood', 'aiConfigLabel', 'aiInfoText', 'btnSync'];
            const keys = ['gateSubtitle', 'btnUser', 'btnCare', 'gateQuote', 'loginTitle', 'btnLogin', 'btnCancel', 'menuLabel', 'govTitle', 'govMessage', 'langLabel', 'donateLabel', 'donateText', 'dashLabel', 'aiStatus', 'dashTitle', 'statTotalLabel', 'statMoodLabel', 'statMoodValue', 'aiConfig', 'aiInfo', 'btnSync'];
            
            ids.forEach((id, i) => {
                const el = document.getElementById(id);
                if(el) el.innerText = t[keys[i]];
            });

            document.getElementById('loginEmail').placeholder = t.emailHolder;
            document.getElementById('loginPass').placeholder = t.passHolder;
            document.getElementById('api_key_input').placeholder = t.apiKeyPlaceholder;
            document.getElementById('entrada').placeholder = t.placeholder;

            renderIcons();
            if (recognition) recognition.lang = lang;
        }

        // Sintetizador de Voz (Prioriza API, fallback para Browser)
        async function speak(text) {
            // Se tiver chave e internet, tenta API de alta qualidade
            if (apiKey && navigator.onLine) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: text }] }],
                            generationConfig: {
                                responseModalities: ["AUDIO"],
                                speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } }
                            }
                        })
                    });
                    const data = await response.json();
                    if(data.candidates && data.candidates[0].content) {
                        const audioData = data.candidates[0].content.parts[0].inlineData.data;
                        playAudio(audioData);
                        return;
                    }
                } catch (err) {
                    console.warn("Falha na voz API, usando fallback local.");
                }
            }
            
            // Fallback: Web Speech API (Voz do Navegador)
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = currentLang;
            utterance.rate = 0.9; // Um pouco mais lento para ser acolhedor
            utterance.pitch = 1.1; // Tom levemente mais amig√°vel
            window.speechSynthesis.speak(utterance);
        }

        function playAudio(base64Data) {
            const binaryString = window.atob(base64Data);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
            
            const wavData = createWavHeader(bytes.buffer, 24000);
            const blob = new Blob([wavData], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            const audio = new Audio(url);
            audio.play();
        }

        function createWavHeader(pcmBuffer, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcmBuffer.byteLength);
            const view = new DataView(buffer);
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };
            writeString(0, 'RIFF'); view.setUint32(4, 36 + pcmBuffer.byteLength, true); writeString(8, 'WAVE'); writeString(12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeString(36, 'data');
            view.setUint32(40, pcmBuffer.byteLength, true);
            const pcmView = new Uint8Array(pcmBuffer); const wavView = new Uint8Array(buffer, 44); wavView.set(pcmView);
            return buffer;
        }

        function setupRecognition() {
            if (!('webkitSpeechRecognition' in window)) return;
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false; recognition.interimResults = false; recognition.lang = currentLang;
            recognition.onresult = (e) => {
                const txt = e.results[0][0].transcript;
                document.getElementById('entrada').value = txt;
                isListening = false; updateMicUI();
                responder();
            };
            recognition.onend = () => { isListening = false; updateMicUI(); };
        }

        function toggleListening() {
            if (!recognition) return;
            if (isListening) { recognition.stop(); } else { recognition.start(); isListening = true; }
            updateMicUI();
        }

        function updateMicUI() {
            document.getElementById('micBtn').classList.toggle('listening', isListening);
        }

        function showLogin(type) { document.getElementById('loginModal').classList.remove('hidden'); }
        function hideLogin() { document.getElementById('loginModal').classList.add('hidden'); }

        function enableVoiceAndStartApp() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('voiceGate').classList.add('hidden');
            
            // Inicia audio context com gesto do usu√°rio
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            audioCtx.resume();

            setupRecognition();
            initChart();
            carregarEstado();
            renderIcons();
            
            // Boas vindas iniciais
            const welcomeMsg = translations[currentLang].welcome;
            addMsg(welcomeMsg, 'bot');
            speak(welcomeMsg);
        }

        function renderIcons() {
            const grid = document.getElementById('pictogramasGrid');
            const t = translations[currentLang];
            grid.innerHTML = '';
            iconsData.forEach(icon => {
                const btn = document.createElement('button');
                btn.className = "glass p-3 rounded-2xl flex flex-col items-center active:scale-95 transition-all hover:bg-white/10 border border-white/5 shadow-lg";
                btn.onclick = () => { 
                    const rawText = t.icons[icon.key];
                    document.getElementById('entrada').value = rawText; 
                    responder(); 
                };
                btn.innerHTML = `<span class="text-3xl mb-1 filter drop-shadow-md">${icon.i}</span><span class="text-[9px] font-black uppercase text-blue-200 tracking-wider">${t.icons[icon.key]}</span>`;
                grid.appendChild(btn);
            });
        }

        function addMsg(txt, type) {
            const display = document.getElementById('chatDisplay');
            const div = document.createElement('div');
            // Estilos distintos para usu√°rio e bot
            const styles = type === 'user' 
                ? 'bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-br-none ml-auto shadow-lg shadow-blue-900/40' 
                : 'glass text-slate-100 rounded-bl-none mr-auto border-white/10 shadow-lg';
            
            div.className = `message-anim px-5 py-3 text-sm rounded-[1.5rem] max-w-[85%] leading-relaxed ${styles}`;
            
            // √çcone pequeno para identificar bot
            const icon = type === 'bot' ? '<span class="mr-2 text-blue-400 text-xs">‚óè</span>' : '';
            div.innerHTML = `${icon}${txt}`;
            
            display.appendChild(div);
            display.scrollTop = display.scrollHeight;
            if(type === 'user') { interactionsCount++; updateStats(); }
        }

        async function responder() {
            const input = document.getElementById('entrada');
            const txt = input.value.trim();
            if(!txt) return;
            
            input.value = '';
            addMsg(txt, 'user');
            
            // Mostra indicador de processamento
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typing';
            typingIndicator.className = 'glass p-3 rounded-[1.5rem] mr-auto w-12 flex justify-center space-x-1 items-center animate-pulse';
            typingIndicator.innerHTML = '<div class="w-1.5 h-1.5 bg-white rounded-full"></div><div class="w-1.5 h-1.5 bg-white rounded-full"></div>';
            document.getElementById('chatDisplay').appendChild(typingIndicator);
            document.getElementById('chatDisplay').scrollTop = document.getElementById('chatDisplay').scrollHeight;

            let reply = "";

            // L√ìGICA H√çBRIDA: Tenta API se dispon√≠vel, sen√£o usa SmartEngine Local
            if(apiKey && navigator.onLine) {
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: `Aja como Tecla, uma IA emp√°tica e protetora criada por Dala de Carvalho. Responda brevemente e com acolhimento total em ${currentLang} para: "${txt}". N√£o invente fatos, foque na emo√ß√£o.` }] }] })
                    });
                    const data = await res.json();
                    reply = data.candidates[0].content.parts[0].text;
                } catch (e) {
                    console.log("Erro API, fallback local.");
                    reply = SmartEngine.process(txt, currentLang);
                }
            } else {
                // MODO OFFLINE / SEM CHAVE (Padr√£o Otimizado)
                // Simula um delay natural de pensamento
                await new Promise(r => setTimeout(r, 600));
                reply = SmartEngine.process(txt, currentLang);
            }

            // Remove indicador de typing
            const typer = document.getElementById('typing');
            if(typer) typer.remove();

            addMsg(reply, 'bot');
            speak(reply); // Fala a resposta completa e processada
        }

        function initChart() {
            const ctx = document.getElementById('interactionChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['0h', '4h', '8h', '12h', '16h', '20h'],
                    datasets: [{ 
                        label: 'Intera√ß√µes', 
                        data: [0, 0, 0, 0, 0, 0], 
                        borderColor: '#60a5fa', 
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.4)');
                            gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
                            return gradient;
                        },
                        fill: true, 
                        tension: 0.4, 
                        borderWidth: 2, 
                        pointRadius: 3,
                        pointBackgroundColor: '#ffffff'
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { y: { display: false }, x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 9 } } } } 
                }
            });
        }

        function updateStats() {
            if(chartInstance) {
                const hour = new Date().getHours();
                const idx = Math.floor(hour / 4);
                const currentVal = chartInstance.data.datasets[0].data[idx] || 0;
                chartInstance.data.datasets[0].data[idx] = currentVal + 1;
                chartInstance.update();
            }
            document.getElementById('statTotal').innerText = interactionsCount;
        }

        function toggleMenu() { document.getElementById('sideMenu').classList.toggle('open'); document.getElementById('menuOverlay').classList.toggle('hidden'); }
        function toggleModo() { modo = (modo === 'user' ? 'admin' : 'user'); document.getElementById('dashboardSection').classList.toggle('hidden', modo === 'user'); document.getElementById('badgeModo').innerText = modo.toUpperCase(); }
        function salvarEstado() { apiKey = document.getElementById('api_key_input').value; localStorage.setItem('tecla_v5_cfg', JSON.stringify({key: apiKey, lang: currentLang})); alert('Configura√ß√µes salvas!'); }
        function carregarEstado() {
            const cfg = JSON.parse(localStorage.getItem('tecla_v5_cfg') || '{}');
            if(cfg.key) { apiKey = cfg.key; document.getElementById('api_key_input').value = cfg.key; }
            if(cfg.lang) setLanguage(cfg.lang);
        }

        window.onload = () => {
            renderIcons();
        };
    </script>
</body>
</html>
