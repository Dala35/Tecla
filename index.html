<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tecla - Plataforma de ConexÃ£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');

        :root { 
            --primary: #3b82f6; 
            --slate-950: #020617;
        }

        body {
            background-color: var(--slate-950);
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            position: fixed;
            width: 100%; height: 100%;
        }

        .glass { 
            background: rgba(15, 23, 42, 0.8); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
        }

        #sideMenu {
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(100%);
        }
        #sideMenu.open { transform: translateX(0); }

        .message-anim { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }

        .listening {
            animation: pulse-red 1.5s infinite;
            background: #ef4444 !important;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="fixed inset-0 flex flex-col">

    <!-- Gate de Entrada -->
    <div id="voiceGate" class="fixed inset-0 z-[200] flex items-center justify-center bg-slate-950 p-6">
        <div class="p-10 glass rounded-[3rem] max-w-sm text-center shadow-2xl">
            <h1 class="text-5xl font-extrabold mb-2 bg-gradient-to-b from-white to-blue-500 bg-clip-text text-transparent italic tracking-tighter">TECLA</h1>
            <p id="gateSubtitle" class="mb-8 text-slate-500 text-[10px] font-black uppercase tracking-[0.3em]">ConexÃ£o Humana & IA</p>
            
            <div class="space-y-3 mb-8">
                <button onclick="showLogin('usuario')" id="btnUserLogin" class="w-full py-4 bg-blue-600 rounded-2xl font-black text-xs tracking-widest hover:bg-blue-500 transition-all">ENTRAR COMO USUÃRIO</button>
                <button onclick="showLogin('cuidador')" id="btnCareLogin" class="w-full py-4 glass rounded-2xl font-black text-xs tracking-widest hover:bg-white/5 transition-all">ENTRAR COMO CUIDADOR</button>
            </div>
            <p id="gateQuote" class="text-[9px] text-slate-600 italic">"Nenhuma voz deve ser silenciada."</p>
        </div>
    </div>

    <!-- Modal de Login -->
    <div id="loginModal" class="fixed inset-0 z-[210] glass flex items-center justify-center hidden p-6">
        <div class="p-8 bg-slate-900 rounded-[2.5rem] w-full max-w-xs border border-white/10">
            <h2 id="loginTitle" class="text-xl font-black mb-6 uppercase tracking-tighter text-white italic">Login</h2>
            <input type="email" id="loginEmail" placeholder="Email" class="w-full p-4 bg-slate-950 rounded-xl mb-3 text-sm outline-none border border-white/5 text-white">
            <input type="password" id="loginPass" placeholder="Palavra-passe" class="w-full p-4 bg-slate-950 rounded-xl mb-6 text-sm outline-none border border-white/5 text-white">
            <button onclick="enableVoiceAndStartApp()" id="btnLoginAction" class="w-full py-4 bg-blue-600 rounded-xl font-black text-xs uppercase">Acessar Portal</button>
            <button onclick="hideLogin()" id="btnCancelLogin" class="w-full py-3 mt-2 text-slate-500 text-[10px] font-bold uppercase tracking-widest">Cancelar</button>
        </div>
    </div>

    <!-- Menu Lateral -->
    <div id="menuOverlay" onclick="toggleMenu()" class="fixed inset-0 bg-black/90 z-[100] hidden"></div>
    <aside id="sideMenu" class="fixed top-0 right-0 h-full glass z-[110] w-[85%] max-w-[320px] p-8 flex flex-col overflow-y-auto">
        <div class="flex justify-between items-center mb-10">
            <span id="menuLabel" class="text-[10px] font-black tracking-widest text-blue-500 uppercase">GovernanÃ§a e ConfiguraÃ§Ãµes</span>
            <button onclick="toggleMenu()" class="p-2 text-white">âœ•</button>
        </div>

        <!-- Mensagem de GovernanÃ§a -->
        <div class="mb-8 p-6 rounded-[2rem] bg-blue-600/10 border border-blue-500/20">
            <h3 id="govTitle" class="text-xs font-black mb-3 uppercase text-blue-400">Sobre a Plataforma</h3>
            <p id="govMessage" class="text-[10px] text-slate-300 leading-relaxed italic">
                A Tecla Ã© um ecossistema dedicado a devolver a autonomia de comunicaÃ§Ã£o a quem a perdeu. AtravÃ©s de tecnologia assistiva e IA, garantimos que a dignidade humana e a expressÃ£o individual sejam preservadas. Este projeto Ã© gerido sob rigorosos princÃ­pios de transparÃªncia e impacto social.
            </p>
        </div>

        <!-- SeleÃ§Ã£o de Idioma -->
        <div class="mb-8">
            <h3 id="langLabel" class="text-[10px] font-black mb-4 uppercase text-slate-500 tracking-widest">Idioma do Sistema</h3>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="setLanguage('pt-PT')" class="p-3 glass rounded-xl text-[9px] font-bold hover:bg-white/5 text-white">PortuguÃªs</button>
                <button onclick="setLanguage('en-US')" class="p-3 glass rounded-xl text-[9px] font-bold hover:bg-white/5 text-white">English</button>
                <button onclick="setLanguage('fr-FR')" class="p-3 glass rounded-xl text-[9px] font-bold hover:bg-white/5 text-white">FranÃ§ais</button>
                <button onclick="setLanguage('zh-CN')" class="p-3 glass rounded-xl text-[9px] font-bold hover:bg-white/5 text-white">ä¸­æ–‡ (Mandarim)</button>
            </div>
        </div>

        <!-- DoaÃ§Ã£o -->
        <div class="mb-8 p-6 rounded-[2rem] bg-gradient-to-br from-pink-600/20 to-transparent border border-pink-500/20">
            <h3 id="donateLabel" class="text-xs font-black mb-2 uppercase text-white">Apoie a Tecla ğŸ’</h3>
            <p id="donateText" class="text-[10px] text-slate-400 leading-relaxed mb-4">Sua doaÃ§Ã£o ajuda a expandir nossa IA e manter a plataforma gratuita para quem mais precisa.</p>
            <div class="space-y-2">
                <form action="https://www.paypal.com/donate" method="post" target="_blank">
                    <input type="hidden" name="business" value="dalla.decarvalho@gmail.com" />
                    <button type="submit" class="block w-full py-3 bg-white/5 hover:bg-blue-600/20 text-center rounded-xl text-[9px] font-black uppercase tracking-widest border border-white/5 text-white transition-all">PAYPAL</button>
                </form>
                <a href="https://buy.stripe.com/exemplo" target="_blank" class="block w-full py-3 bg-white/5 hover:bg-blue-600/20 text-center rounded-xl text-[9px] font-black uppercase tracking-widest border border-white/5 text-white transition-all">STRIPE</a>
            </div>
        </div>

        <button onclick="toggleModo(); toggleMenu();" class="w-full p-5 glass rounded-2xl flex justify-between items-center mb-4">
            <span id="dashLabel" class="text-[10px] font-black uppercase text-white">Dashboard Cuidador</span>
            <span id="badgeModo" class="text-[8px] bg-blue-500 px-2 py-1 rounded text-white">USER</span>
        </button>

        <div class="mt-auto text-center opacity-30 text-[8px] font-black uppercase tracking-[0.5em] text-white">TECLA ECOSYSTEM</div>
    </aside>

    <!-- Header -->
    <header class="p-5 flex justify-between items-center glass z-40 shrink-0">
        <div class="flex items-center space-x-3">
            <span class="font-black italic text-xl tracking-tighter text-white">TECLA</span>
            <div id="aiIndicator" class="flex items-center space-x-1 px-2 py-1 bg-green-500/10 rounded-full">
                <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
                <span id="aiStatusText" class="text-[7px] font-black text-green-500 uppercase italic">Modo IA Ativo</span>
            </div>
        </div>
        <button onclick="toggleMenu()" class="p-2 glass rounded-xl text-white text-lg">â˜°</button>
    </header>

    <main class="flex-1 flex flex-col relative overflow-hidden bg-slate-950">
        
        <!-- Dashboard Admin -->
        <section id="dashboardSection" class="hidden absolute inset-0 z-50 glass p-6 overflow-y-auto">
            <h3 id="dashTitle" class="text-xs font-black mb-6 uppercase tracking-widest text-blue-500 italic">Monitoramento de Atividade</h3>
            
            <div class="bg-slate-900/50 p-4 rounded-[2rem] border border-white/5 mb-6">
                <canvas id="interactionChart" height="200"></canvas>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-4 glass rounded-2xl text-center">
                    <span id="statLabelTotal" class="text-[8px] font-black text-slate-500 uppercase block mb-1 tracking-widest">Total Hoje</span>
                    <span id="statTotal" class="text-xl font-black text-white">0</span>
                </div>
                <div class="p-4 glass rounded-2xl text-center">
                    <span id="statLabelMood" class="text-[8px] font-black text-slate-500 uppercase block mb-1 tracking-widest">Humor MÃ©dio</span>
                    <span id="statMood" class="text-xl font-black text-blue-400">EstÃ¡vel</span>
                </div>
            </div>

            <div class="p-4 glass rounded-2xl border-white/5">
                <h4 id="aiConfigLabel" class="text-[9px] font-black uppercase text-slate-500 mb-3 tracking-widest">ConfiguraÃ§Ãµes de IA</h4>
                <input type="password" id="api_key_input" placeholder="Chave Gemini API" class="w-full p-4 bg-slate-950 rounded-xl mb-3 text-xs outline-none border border-white/5 text-white">
                <button onclick="salvarEstado()" id="btnSync" class="w-full py-4 bg-blue-600 rounded-xl font-black text-[10px] uppercase italic">Sincronizar Canal</button>
            </div>
        </section>

        <!-- Chat Principal -->
        <div id="chatDisplay" class="flex-1 overflow-y-auto p-5 space-y-4"></div>

        <!-- Pictogramas RÃ¡pidos -->
        <div id="pictogramasGrid" class="grid grid-cols-3 gap-2 px-5 pb-3 shrink-0"></div>

        <!-- Input -->
        <div class="pb-safe px-5 pb-5 shrink-0">
            <div class="flex items-center glass rounded-[2.5rem] p-1.5 shadow-2xl space-x-2">
                <button id="micBtn" onclick="toggleListening()" class="p-4 glass rounded-full hover:bg-white/5 transition-all text-blue-500">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                </button>
                <input type="text" id="entrada" onkeypress="if(event.key==='Enter') responder()" placeholder="Escreva..." class="flex-1 bg-transparent px-2 py-4 outline-none text-sm font-medium text-white">
                <button onclick="responder()" class="p-4 bg-blue-600 rounded-full active:scale-90 transition-transform">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M13 5l7 7-7 7M5 5l7 7-7 7"/></svg>
                </button>
            </div>
        </div>
    </main>

    <script>
        let currentLang = 'pt-PT';
        let modo = 'user';
        let apiKey = '';
        let interactionsCount = 0;
        let chartInstance = null;
        let recognition = null;
        let isListening = false;

        const translations = {
            'pt-PT': {
                gateSubtitle: 'ConexÃ£o Humana & IA',
                btnUser: 'ENTRAR COMO USUÃRIO',
                btnCare: 'ENTRAR COMO CUIDADOR',
                gateQuote: '"Nenhuma voz deve ser silenciada."',
                loginTitle: 'Acesso Restrito',
                emailPlaceholder: 'Email',
                passPlaceholder: 'Palavra-passe',
                btnLogin: 'ACESSAR PORTAL',
                btnCancel: 'CANCELAR',
                menuLabel: 'GovernanÃ§a e ConfiguraÃ§Ãµes',
                govTitle: 'Sobre a Plataforma',
                govMessage: 'A Tecla Ã© um ecossistema dedicado a devolver a autonomia de comunicaÃ§Ã£o a quem a perdeu. AtravÃ©s de tecnologia assistiva e IA, garantimos que a dignidade humana e a expressÃ£o individual sejam preservadas. Este projeto Ã© gerido sob rigorosos princÃ­pios de transparÃªncia e impacto social.',
                langLabel: 'Idioma do Sistema',
                donateLabel: 'Apoie a Tecla ğŸ’',
                donateText: 'Sua doaÃ§Ã£o ajuda a expandir nossa IA e manter a plataforma gratuita para quem mais precisa.',
                dashLabel: 'Dashboard Cuidador',
                aiStatus: 'Modo IA Ativo',
                dashTitle: 'Monitoramento de Atividade',
                statTotalLabel: 'Total Hoje',
                statMoodLabel: 'Humor MÃ©dio',
                statMoodValue: 'EstÃ¡vel',
                aiConfig: 'ConfiguraÃ§Ãµes de IA',
                apiKeyPlaceholder: 'Chave Gemini API',
                btnSync: 'Sincronizar Canal',
                welcome: 'ConexÃ£o estabelecida. Como posso ajudar hoje?',
                placeholder: 'Escreva ou use o microfone...',
                icons: { comer: 'Comer', dor: 'Dor', ajuda: 'Ajuda', banho: 'Banho', amor: 'Amor', dormir: 'Dormir' }
            },
            'en-US': {
                gateSubtitle: 'Human & AI Connection',
                btnUser: 'ENTER AS USER',
                btnCare: 'ENTER AS CAREGIVER',
                gateQuote: '"No voice should be silenced."',
                loginTitle: 'Restricted Access',
                emailPlaceholder: 'Email',
                passPlaceholder: 'Password',
                btnLogin: 'ACCESS PORTAL',
                btnCancel: 'CANCEL',
                menuLabel: 'Governance & Settings',
                govTitle: 'About the Platform',
                govMessage: 'Tecla is an ecosystem dedicated to restoring communication autonomy to those who have lost it. Through assistive technology and AI, we ensure that human dignity and individual expression are preserved. This project is managed under strict principles of transparency and social impact.',
                langLabel: 'System Language',
                donateLabel: 'Support Tecla ğŸ’',
                donateText: 'Your donation helps expand our AI and keep the platform free for those who need it most.',
                dashLabel: 'Caregiver Dashboard',
                aiStatus: 'AI Mode Active',
                dashTitle: 'Activity Monitoring',
                statTotalLabel: 'Total Today',
                statMoodLabel: 'Average Mood',
                statMoodValue: 'Stable',
                aiConfig: 'AI Settings',
                apiKeyPlaceholder: 'Gemini API Key',
                btnSync: 'Sync Channel',
                welcome: 'Connection established. How can I help today?',
                placeholder: 'Type or use microphone...',
                icons: { comer: 'Eat', dor: 'Pain', ajuda: 'Help', banho: 'Bath', amor: 'Love', dormir: 'Sleep' }
            },
            'fr-FR': {
                gateSubtitle: 'Connexion Humaine & IA',
                btnUser: 'ENTRER COMME UTILISATEUR',
                btnCare: 'ENTRER COMME AIDANT',
                gateQuote: '"Aucune voix ne doit Ãªtre rÃ©duite au silence."',
                loginTitle: 'AccÃ¨s Restreint',
                emailPlaceholder: 'E-mail',
                passPlaceholder: 'Mot de passe',
                btnLogin: 'ACCÃ‰DER AU PORTAIL',
                btnCancel: 'ANNULER',
                menuLabel: 'Gouvernance et ParamÃ¨tres',
                govTitle: 'Ã€ propos de la plateforme',
                govMessage: 'Tecla est un Ã©cosystÃ¨me dÃ©diÃ© Ã  redonner l\'autonomie de communication Ã  ceux qui l\'ont perdue. GrÃ¢ce aux technologies d\'assistance et Ã  l\'IA, nous veillons Ã  ce que la dignitÃ© humaine et l\'expression individuelle soient prÃ©servÃ©es. Ce projet est gÃ©rÃ© selon des principes stricts de transparence et d\'impact social.',
                langLabel: 'Langue du SystÃ¨me',
                donateLabel: 'Soutenir Tecla ğŸ’',
                donateText: 'Votre don aide Ã  dÃ©velopper notre IA et Ã  maintenir la plateforme gratuite pour ceux qui en ont le plus besoin.',
                dashLabel: 'Tableau de bord de l\'aidant',
                aiStatus: 'Mode IA Actif',
                dashTitle: 'Suivi d\'activitÃ©',
                statTotalLabel: 'Total Aujourd\'hui',
                statMoodLabel: 'Humeur Moyenne',
                statMoodValue: 'Stable',
                aiConfig: 'ParamÃ¨tres d\'IA',
                apiKeyPlaceholder: 'ClÃ© API Gemini',
                btnSync: 'Synchroniser le canal',
                welcome: 'Connexion Ã©tablie. Comment puis-je vous aider?',
                placeholder: 'Ã‰crivez ou utilisez le micro...',
                icons: { comer: 'Manger', dor: 'Douleur', ajuda: 'Aide', banho: 'Bain', amor: 'Amour', dormir: 'Dormir' }
            },
            'zh-CN': {
                gateSubtitle: 'äººç±»ä¸äººå·¥æ™ºèƒ½è¿æ¥',
                btnUser: 'ä»¥ç”¨æˆ·èº«ä»½è¿›å…¥',
                btnCare: 'ä»¥æŠ¤ç†äººå‘˜èº«ä»½è¿›å…¥',
                gateQuote: 'â€œä»»ä½•å£°éŸ³éƒ½ä¸åº”è¯¥è¢«æ²‰é»˜ã€‚â€',
                loginTitle: 'å—é™è®¿é—®',
                emailPlaceholder: 'ç”µå­é‚®ä»¶',
                passPlaceholder: 'å¯†ç ',
                btnLogin: 'è¿›å…¥é—¨æˆ·',
                btnCancel: 'å–æ¶ˆ',
                menuLabel: 'æ²»ç†ä¸è®¾ç½®',
                govTitle: 'å…³äºå¹³å°',
                govMessage: 'Tecla æ˜¯ä¸€ä¸ªè‡´åŠ›äºä¸ºå¤±å»æ²Ÿé€šèƒ½åŠ›çš„äººæ¢å¤æ²Ÿé€šè‡ªä¸»æƒçš„ç”Ÿæ€ç³»ç»Ÿã€‚é€šè¿‡è¾…åŠ©æŠ€æœ¯å’Œäººå·¥æ™ºèƒ½ï¼Œæˆ‘ä»¬ç¡®ä¿äººç±»å°Šä¸¥å’Œä¸ªäººè¡¨è¾¾å¾—åˆ°ç»´æŠ¤ã€‚è¯¥é¡¹ç›®æ ¹æ®é€æ˜åº¦å’Œç¤¾ä¼šå½±å“çš„ä¸¥æ ¼åŸåˆ™è¿›è¡Œç®¡ç†ã€‚',
                langLabel: 'ç³»ç»Ÿè¯­è¨€',
                donateLabel: 'æ”¯æŒ Tecla ğŸ’',
                donateText: 'æ‚¨çš„ææ¬¾æœ‰åŠ©äºæ‰©å±•æˆ‘ä»¬çš„äººå·¥æ™ºèƒ½ï¼Œå¹¶ä¸ºæœ€éœ€è¦çš„äººä¿æŒå¹³å°å…è´¹ã€‚',
                dashLabel: 'æŠ¤ç†äººå‘˜ä»ªè¡¨æ¿',
                aiStatus: 'äººå·¥æ™ºèƒ½æ¨¡å¼æ¿€æ´»',
                dashTitle: 'æ´»åŠ¨ç›‘æµ‹',
                statTotalLabel: 'ä»Šæ—¥æ€»è®¡',
                statMoodLabel: 'å¹³å‡æƒ…ç»ª',
                statMoodValue: 'ç¨³å®š',
                aiConfig: 'äººå·¥æ™ºèƒ½è®¾ç½®',
                apiKeyPlaceholder: 'Gemini API å¯†é’¥',
                btnSync: 'åŒæ­¥é¢‘é“',
                welcome: 'è¿æ¥å·²å»ºç«‹ã€‚ä»Šå¤©æˆ‘èƒ½å¦‚ä½•å¸®æ‚¨ï¼Ÿ',
                placeholder: 'è¾“å…¥æˆ–ä½¿ç”¨éº¦å…‹é£...',
                icons: { comer: 'åƒ', dor: 'ç–¼ç—›', ajuda: 'å¸®åŠ©', banho: 'æ´—æ¾¡', amor: 'çˆ±', dormir: 'ç¡è§‰' }
            }
        };

        const iconsData = [
            { key: 'comer', i: 'ğŸ½ï¸' }, { key: 'dor', i: 'ğŸ¤•' }, { key: 'ajuda', i: 'ğŸ†˜' },
            { key: 'banho', i: 'ğŸš¿' }, { key: 'amor', i: 'â¤ï¸' }, { key: 'dormir', i: 'ğŸ˜´' }
        ];

        // --- TraduÃ§Ã£o em Tempo Real ---
        function setLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];
            
            // PortÃ£o e Login
            document.getElementById('gateSubtitle').innerText = t.gateSubtitle;
            document.getElementById('btnUserLogin').innerText = t.btnUser;
            document.getElementById('btnCareLogin').innerText = t.btnCare;
            document.getElementById('gateQuote').innerText = t.gateQuote;
            document.getElementById('loginTitle').innerText = t.loginTitle;
            document.getElementById('loginEmail').placeholder = t.emailPlaceholder;
            document.getElementById('loginPass').placeholder = t.passPlaceholder;
            document.getElementById('btnLoginAction').innerText = t.btnLogin;
            document.getElementById('btnCancelLogin').innerText = t.btnCancel;

            // Menu Lateral
            document.getElementById('menuLabel').innerText = t.menuLabel;
            document.getElementById('govTitle').innerText = t.govTitle;
            document.getElementById('govMessage').innerText = t.govMessage;
            document.getElementById('langLabel').innerText = t.langLabel;
            document.getElementById('donateLabel').innerText = t.donateLabel;
            document.getElementById('donateText').innerText = t.donateText;
            document.getElementById('dashLabel').innerText = t.dashLabel;

            // Header e Dashboard
            document.getElementById('aiStatusText').innerText = t.aiStatus;
            document.getElementById('dashTitle').innerText = t.dashTitle;
            document.getElementById('statLabelTotal').innerText = t.statTotalLabel;
            document.getElementById('statLabelMood').innerText = t.statMoodLabel;
            document.getElementById('statMood').innerText = t.statMoodValue;
            document.getElementById('aiConfigLabel').innerText = t.aiConfig;
            document.getElementById('api_key_input').placeholder = t.apiKeyPlaceholder;
            document.getElementById('btnSync').innerText = t.btnSync;

            // Chat Input
            document.getElementById('entrada').placeholder = t.placeholder;

            renderIcons();
            if (recognition) recognition.lang = lang;
        }

        // --- TTS Logic (Voz de Resposta) ---
        async function speak(text) {
            if (!apiKey) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = currentLang;
                window.speechSynthesis.speak(utterance);
                return;
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } }
                        }
                    })
                });

                const data = await response.json();
                const audioData = data.candidates[0].content.parts[0].inlineData.data;
                playAudio(audioData);
            } catch (err) {
                console.error("Erro voz:", err);
            }
        }

        function playAudio(base64Data) {
            const binaryString = window.atob(base64Data);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
            
            const wavData = createWavHeader(bytes.buffer, 24000);
            const blob = new Blob([wavData], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            const audio = new Audio(url);
            audio.play();
        }

        function createWavHeader(pcmBuffer, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcmBuffer.byteLength);
            const view = new DataView(buffer);
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };
            writeString(0, 'RIFF'); view.setUint32(4, 36 + pcmBuffer.byteLength, true); writeString(8, 'WAVE'); writeString(12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeString(36, 'data');
            view.setUint32(40, pcmBuffer.byteLength, true);
            const pcmView = new Uint8Array(pcmBuffer); const wavView = new Uint8Array(buffer, 44); wavView.set(pcmView);
            return buffer;
        }

        // --- Reconhecimento de Fala ---
        function setupRecognition() {
            if (!('webkitSpeechRecognition' in window)) return;
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false; recognition.interimResults = false; recognition.lang = currentLang;
            recognition.onresult = (e) => {
                const txt = e.results[0][0].transcript;
                document.getElementById('entrada').value = txt;
                isListening = false; updateMicUI();
                responder();
            };
            recognition.onend = () => { isListening = false; updateMicUI(); };
        }

        function toggleListening() {
            if (!recognition) return;
            if (isListening) { recognition.stop(); } else { recognition.start(); isListening = true; }
            updateMicUI();
        }

        function updateMicUI() {
            const btn = document.getElementById('micBtn');
            btn.classList.toggle('listening', isListening);
        }

        function showLogin(type) { document.getElementById('loginModal').classList.remove('hidden'); }
        function hideLogin() { document.getElementById('loginModal').classList.add('hidden'); }

        function enableVoiceAndStartApp() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('voiceGate').classList.add('hidden');
            setupRecognition();
            initChart();
            carregarEstado();
            renderIcons();
            const welcomeMsg = translations[currentLang].welcome;
            addMsg(welcomeMsg, 'bot');
            speak(welcomeMsg);
        }

        function renderIcons() {
            const grid = document.getElementById('pictogramasGrid');
            const t = translations[currentLang];
            grid.innerHTML = '';
            iconsData.forEach(icon => {
                const btn = document.createElement('button');
                btn.className = "glass p-4 rounded-3xl flex flex-col items-center active:scale-95 transition-transform";
                btn.onclick = () => { 
                    const txt = t.icons[icon.key];
                    document.getElementById('entrada').value = txt; 
                    speak(txt); 
                    responder(); 
                };
                btn.innerHTML = `<span class="text-2xl">${icon.i}</span><span class="text-[8px] font-black uppercase mt-1 text-slate-500">${t.icons[icon.key]}</span>`;
                grid.appendChild(btn);
            });
        }

        function addMsg(txt, type) {
            const display = document.getElementById('chatDisplay');
            const div = document.createElement('div');
            div.className = `message-anim p-4 text-xs max-w-[85%] ${type === 'user' ? 'bg-blue-600 text-white rounded-[1.5rem] ml-auto' : 'glass text-white rounded-[1.5rem] mr-auto border-white/5'}`;
            div.innerText = txt;
            display.appendChild(div);
            display.scrollTop = display.scrollHeight;
            if(type === 'user') { interactionsCount++; updateStats(); }
        }

        async function responder() {
            const input = document.getElementById('entrada');
            const txt = input.value.trim();
            if(!txt) return;
            
            input.value = '';
            addMsg(txt, 'user');
            speak(txt); 

            if(apiKey) {
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: `Act as Tecla AI. Very brief empathetic response in ${currentLang}: ${txt}` }] }] })
                    });
                    const data = await res.json();
                    const reply = data.candidates[0].content.parts[0].text;
                    addMsg(reply, 'bot');
                    speak(reply); 
                } catch (e) {
                    addMsg("...", 'bot');
                }
            } else {
                setTimeout(() => addMsg("...", 'bot'), 600);
            }
        }

        function initChart() {
            const ctx = document.getElementById('interactionChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['0h', '4h', '8h', '12h', '16h', '20h'],
                    datasets: [{ label: 'InteraÃ§Ãµes', data: [0, 0, 0, 0, 0, 0], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4, borderWidth: 3, pointRadius: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false }, ticks: { display: false } }, x: { grid: { display: false }, ticks: { color: '#475569', font: { size: 9 } } } } }
            });
        }

        function updateStats() {
            if(chartInstance) {
                const hour = new Date().getHours();
                const idx = Math.floor(hour / 4);
                chartInstance.data.datasets[0].data[idx] = (chartInstance.data.datasets[0].data[idx] || 0) + 1;
                chartInstance.update();
            }
            document.getElementById('statTotal').innerText = interactionsCount;
        }

        function toggleMenu() { document.getElementById('sideMenu').classList.toggle('open'); document.getElementById('menuOverlay').classList.toggle('hidden'); }
        function toggleModo() { modo = (modo === 'user' ? 'admin' : 'user'); document.getElementById('dashboardSection').classList.toggle('hidden', modo === 'user'); document.getElementById('badgeModo').innerText = modo.toUpperCase(); }
        function salvarEstado() { apiKey = document.getElementById('api_key_input').value; localStorage.setItem('tecla_v5_cfg', JSON.stringify({key: apiKey, lang: currentLang})); }
        function carregarEstado() {
            const cfg = JSON.parse(localStorage.getItem('tecla_v5_cfg') || '{}');
            if(cfg.key) { apiKey = cfg.key; document.getElementById('api_key_input').value = cfg.key; }
            if(cfg.lang) setLanguage(cfg.lang);
        }

        window.onload = () => {
            renderIcons();
        };
    </script>
</body>
</html>
